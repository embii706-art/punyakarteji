rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* =====================================================
       COMMON HELPERS
    ====================================================== */

    function isAuthenticated() {
      return request.auth != null;
    }

    function userRef() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }

    function userExists() {
      return isAuthenticated() && exists(userRef());
    }

    function userData() {
      return userExists() ? get(userRef()).data : null;
    }

    function isActive() {
      return userData() != null && userData().isActive == true;
    }

    function hasRole(role) {
      return userData() != null && userData().role == role;
    }

    function isSuperAdmin() {
      return hasRole('super_admin');
    }

    function isAdmin() {
      return isSuperAdmin()
        || hasRole('ketua')
        || hasRole('wakil_ketua');
    }

    function isBendahara() {
      return hasRole('bendahara');
    }

    function isValidRole(role) {
      return role in [
        'super_admin',
        'ketua',
        'wakil_ketua',
        'bendahara',
        'sekretaris',
        'humas',
        'anggota'
      ];
    }

    function canAccessApp() {
      return isAuthenticated() && userExists() && isActive();
    }

    /* =====================================================
       USERS
    ====================================================== */

    match /users/{userId} {

      // User boleh baca data dirinya sendiri
      // Admin boleh baca semua
      allow read: if isAuthenticated()
        && (request.auth.uid == userId || isAdmin());

      // ‚ùå CLIENT TIDAK BOLEH CREATE USER
      // User dibuat via Cloud Function (Admin SDK)
      allow create: if false;

      // User update profil sendiri (field aman)
      allow update: if isAuthenticated()
        && request.auth.uid == userId
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['displayName', 'photoURL']);

      // Admin update role & status saja
      allow update: if isAdmin()
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['role', 'isActive'])
        && isValidRole(request.resource.data.role);

      // Hanya super admin boleh delete user
      allow delete: if isSuperAdmin();
    }

    /* =====================================================
       WASTE DEPOSITS
    ====================================================== */

    match /waste_deposits/{id} {
      allow read, create: if canAccessApp();

      allow update, delete: if canAccessApp()
        && (request.auth.uid == resource.data.createdBy || isAdmin());
    }

    /* =====================================================
       TRANSACTIONS
    ====================================================== */

    match /transactions/{id} {
      allow read: if canAccessApp();

      allow create: if canAccessApp()
        && (isBendahara() || isAdmin());

      allow update: if canAccessApp() && (
        (
          isBendahara()
          && resource.data.status == 'pending'
          && request.resource.data.diff(resource.data)
            .affectedKeys()
            .hasOnly(['amount', 'description'])
        ) ||
        (
          isAdmin()
          && request.resource.data.diff(resource.data)
            .affectedKeys()
            .hasOnly(['status', 'approvedBy', 'approvedAt'])
        )
      );

      allow delete: if isSuperAdmin();
    }

    /* =====================================================
       UMKM
    ====================================================== */

    match /umkm/{id} {
      allow read, create: if canAccessApp();

      allow update, delete: if canAccessApp()
        && (request.auth.uid == resource.data.createdBy || isAdmin());
    }

    /* =====================================================
       BANK SAMPAH
    ====================================================== */

    match /bank_sampah/{id} {
      allow read, create: if canAccessApp();

      allow update, delete: if canAccessApp()
        && (request.auth.uid == resource.data.createdBy || isAdmin());
    }

    /* =====================================================
       KEUANGAN
    ====================================================== */

    match /keuangan/{id} {
      allow read: if canAccessApp();

      allow create: if canAccessApp()
        && (isBendahara() || isAdmin());

      allow update, delete: if canAccessApp()
        && (request.auth.uid == resource.data.createdBy || isAdmin());
    }

    /* =====================================================
       ANGGOTA
    ====================================================== */

    match /anggota/{id} {
      allow read: if canAccessApp();
      allow write: if canAccessApp() && isAdmin();
    }

    /* =====================================================
       ACTIVITIES
    ====================================================== */

    match /activities/{id} {
      allow read, create: if canAccessApp();
      allow update, delete: if isAdmin();
    }

    /* =====================================================
       ASPIRATIONS
    ====================================================== */

    match /aspirations/{id} {
      allow read, create: if canAccessApp();

      allow update: if canAccessApp()
        && (request.auth.uid == resource.data.createdBy || isAdmin());

      allow delete: if isAdmin();
    }

    /* =====================================================
       CONFIG
    ====================================================== */

    match /config/{id} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    /* =====================================================
       DEFAULT DENY (WAJIB ADA)
    ====================================================== */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
